name: Build and Release VSCode Extension

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      publish_to_marketplace:
        description: 'Publish to VS Code Marketplace'
        required: true
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  GO_VERSION: '1.24'
  EXTENSION_NAME: 'cocursor'

jobs:
  # ============================================================================
  # 阶段1: 测试（只运行一次）
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: co-extension/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('co-extension/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: co-extension
        run: npm ci

      # 使用根目录 Makefile 运行测试
      - name: Run CI tests
        run: make ci-test

      - name: Compile TypeScript
        working-directory: co-extension
        run: npm run compile

  # ============================================================================
  # 阶段2: 多平台构建（依赖测试通过）
  # ============================================================================
  build:
    name: Build Extension
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            binary_suffix: linux-amd64
            artifact_name: cocursor-linux-x64
            vsce_target: linux-x64
          - os: windows-latest
            goos: windows
            goarch: amd64
            binary_suffix: windows-amd64.exe
            artifact_name: cocursor-win32-x64
            vsce_target: win32-x64
          - os: macos-latest
            goos: darwin
            goarch: amd64
            binary_suffix: darwin-amd64
            artifact_name: cocursor-darwin-x64
            vsce_target: darwin-x64
          - os: macos-latest
            goos: darwin
            goarch: arm64
            binary_suffix: darwin-arm64
            artifact_name: cocursor-darwin-arm64
            vsce_target: darwin-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: co-extension/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('co-extension/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Windows 安装 Make 以统一构建方式
      - name: Install Make (Windows)
        if: runner.os == 'Windows'
        run: choco install make -y

      - name: Install dependencies
        working-directory: co-extension
        run: npm ci

      # 统一使用 Makefile 构建前端
      - name: Build extension
        run: make build-frontend

      # 统一使用 Makefile 生成 Wire 代码
      - name: Generate Wire code
        run: make wire

      - name: Create bin directory
        run: mkdir -p co-extension/bin
        shell: bash

      # 构建后端 daemon（带版本信息）
      - name: Build backend daemon (Unix-like)
        if: runner.os != 'Windows'
        working-directory: backend
        run: |
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build \
            -ldflags "-X main.Version=${{ github.ref_name }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.GitCommit=${{ github.sha }}" \
            -o ../co-extension/bin/cocursor-${{ matrix.binary_suffix }} ./cmd/server
          chmod +x ../co-extension/bin/cocursor-${{ matrix.binary_suffix }}

      - name: Build backend daemon (Windows)
        if: runner.os == 'Windows'
        working-directory: backend
        shell: pwsh
        run: |
          $env:GOOS="${{ matrix.goos }}"; $env:GOARCH="${{ matrix.goarch }}"
          $buildTime = (Get-Date -AsUTC -Format 'yyyy-MM-ddTHH:mm:ssZ')
          go build -ldflags "-X main.Version=${{ github.ref_name }} -X main.BuildTime=$buildTime -X main.GitCommit=${{ github.sha }}" -o ../co-extension/bin/cocursor-${{ matrix.binary_suffix }} ./cmd/server

      - name: Verify binary files
        run: ls -lh co-extension/bin/
        shell: bash

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package extension
        working-directory: co-extension
        run: vsce package --out ../${{ matrix.artifact_name }}.vsix --target ${{ matrix.vsce_target }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-vsix
          path: ${{ matrix.artifact_name }}.vsix
          retention-days: 30

  # ============================================================================
  # 阶段3: 创建 Release
  # ============================================================================
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.vsix
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # 阶段4: 发布到 Marketplace（并行发布）
  # ============================================================================
  publish-marketplace:
    name: Publish to Marketplace
    needs: release
    runs-on: ubuntu-latest
    if: github.event.inputs.publish_to_marketplace == 'true' || (startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push')
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - artifact_name: cocursor-win32-x64
            platform: Windows-x64
          - artifact_name: cocursor-linux-x64
            platform: Linux-x64
          - artifact_name: cocursor-darwin-x64
            platform: macOS-x64
          - artifact_name: cocursor-darwin-arm64
            platform: macOS-ARM64

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-vsix
          path: artifact

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Publish to Marketplace
        working-directory: artifact
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
          PLATFORM: ${{ matrix.platform }}
        run: |
          # 检查 PAT 是否存在
          if [ -z "$VSCE_PAT" ]; then
            echo "❌ Error: VSCE_PAT secret is not set or empty!"
            echo "Please check: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          echo "✓ VSCE_PAT is configured (length: ${#VSCE_PAT})"
          echo "Publishing ${PLATFORM}..."
          vsce publish -p "${VSCE_PAT}" --packagePath *.vsix
          echo "✅ ${PLATFORM} published successfully!"

  # ============================================================================
  # 阶段5: 发布结果汇总
  # ============================================================================
  publish-summary:
    name: Publish Summary
    needs: publish-marketplace
    runs-on: ubuntu-latest
    if: always() && (github.event.inputs.publish_to_marketplace == 'true' || (startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push'))

    steps:
      - name: Check publish results
        run: |
          echo "=== Marketplace 发布结果汇总 ==="
          echo "请查看各平台的发布 job 状态"
          echo ""
          echo "如有发布失败，请检查以下内容："
          echo "1. VSCE_PAT secret 是否正确配置"
          echo "2. 版本号是否已存在于 Marketplace"
          echo "3. package.json 中的 publisher 是否正确"
