# RAG åŠŸèƒ½ç”¨æˆ·ä½“éªŒè®¾è®¡ï¼ˆQdrant åµŒå…¥å¼æ–¹æ¡ˆï¼‰

## ä¸€ã€æ•´ä½“ç”¨æˆ·æµç¨‹è®¾è®¡

### 1.1 é¦–æ¬¡ä½¿ç”¨æµç¨‹

```
ç”¨æˆ·æ‰“å¼€ RAG åŠŸèƒ½
    â†“
æ£€æŸ¥é…ç½®çŠ¶æ€
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœªé…ç½® â†’ å¼•å¯¼é…ç½®æµç¨‹           â”‚
â”‚  1. å¡«å†™ Embedding API é…ç½®     â”‚
â”‚     - URLï¼ˆå¿…å¡«ï¼‰                â”‚
â”‚     - API Keyï¼ˆå¿…å¡«ï¼‰            â”‚
â”‚     - æ¨¡å‹åç§°ï¼ˆå¯é€‰ï¼Œæœ‰é»˜è®¤å€¼ï¼‰  â”‚
â”‚  2. æµ‹è¯•è¿æ¥                     â”‚
â”‚  3. ä¸‹è½½ Qdrant ç»„ä»¶             â”‚
â”‚  4. åˆå§‹åŒ–å‘é‡åº“                 â”‚
â”‚  5. å¼€å§‹å…¨é‡æ‰«æ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·²é…ç½® â†’ ç›´æ¥è¿›å…¥æœç´¢ç•Œé¢       â”‚
â”‚  æˆ–æ˜¾ç¤ºç´¢å¼•çŠ¶æ€                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 é…ç½®ç•Œé¢è®¾è®¡

#### é…ç½®è¡¨å•å­—æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAG è¯­ä¹‰æœç´¢é…ç½®                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Embedding API é…ç½®                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ API URL:                         â”‚   â”‚
â”‚  â”‚ [https://api.openai.com/v1/...] â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ API Key:                         â”‚   â”‚
â”‚  â”‚ [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢] [æ˜¾ç¤º/éšè—]  â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ æ¨¡å‹åç§°:                        â”‚   â”‚
â”‚  â”‚ [text-embedding-3-small] â–¼      â”‚   â”‚
â”‚  â”‚ (å¯é€‰ï¼Œé»˜è®¤: text-embedding-3-small)â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚
â”‚  æ”¯æŒçš„ API æ ¼å¼:                        â”‚
â”‚  â€¢ OpenAI å…¼å®¹æ ¼å¼                      â”‚
â”‚  â€¢ Azure OpenAI                        â”‚
â”‚  â€¢ å…¶ä»–å…¼å®¹ OpenAI æ ¼å¼çš„ API           â”‚
â”‚                                          â”‚
â”‚  è¯´æ˜: æ”¯æŒæ‰€æœ‰å…¼å®¹ OpenAI Embeddings  â”‚
â”‚  API æ ¼å¼çš„æä¾›å•†                       â”‚
â”‚                                          â”‚
â”‚  [æµ‹è¯•è¿æ¥] [ä¿å­˜é…ç½®]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é…ç½®éªŒè¯æµç¨‹

```
ç”¨æˆ·å¡«å†™é…ç½®
    â†“
ç‚¹å‡»"æµ‹è¯•è¿æ¥"
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯éªŒè¯ï¼š                      â”‚
â”‚  1. æ£€æŸ¥ URL æ ¼å¼               â”‚
â”‚  2. å‘é€æµ‹è¯•è¯·æ±‚ï¼ˆå°æ–‡æœ¬ï¼‰        â”‚
â”‚  3. éªŒè¯è¿”å›æ ¼å¼                 â”‚
â”‚  4. æ£€æŸ¥å‘é‡ç»´åº¦                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆåŠŸ        â”‚  å¤±è´¥        â”‚
â”‚    â†“         â”‚    â†“         â”‚
â”‚ æ˜¾ç¤ºæˆåŠŸæç¤º â”‚ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ â”‚
â”‚ å¯ç”¨ä¿å­˜æŒ‰é’® â”‚ ç¦ç”¨ä¿å­˜æŒ‰é’® â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Qdrant ç»„ä»¶ä¸‹è½½æµç¨‹

```
é…ç½®ä¿å­˜æˆåŠŸ
    â†“
æ£€æŸ¥ Qdrant ç»„ä»¶çŠ¶æ€
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœªä¸‹è½½ â†’ ä¸‹è½½æµç¨‹               â”‚
â”‚  1. æ£€æµ‹å¹³å°å’Œæ¶æ„               â”‚
â”‚  2. æ˜¾ç¤ºä¸‹è½½è¿›åº¦                 â”‚
â”‚  3. éªŒè¯ä¸‹è½½æ–‡ä»¶å®Œæ•´æ€§            â”‚
â”‚  4. è§£å‹/å®‰è£…åˆ°æœ¬åœ°ç›®å½•           â”‚
â”‚  5. åˆå§‹åŒ– Qdrant å‘é‡åº“         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·²ä¸‹è½½ â†’ æ£€æŸ¥ç‰ˆæœ¬               â”‚
â”‚  å¦‚æœç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæç¤ºæ›´æ–°         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸‹è½½ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­£åœ¨ä¸‹è½½ Qdrant ç»„ä»¶...                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  å¹³å°: Windows x64                      â”‚
â”‚  ç‰ˆæœ¬: v1.7.0                           â”‚
â”‚  å¤§å°: ~50 MB                           â”‚
â”‚                                          â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  60%            â”‚
â”‚                                          â”‚
â”‚  å·²ä¸‹è½½: 30 MB / 50 MB                   â”‚
â”‚  é€Ÿåº¦: 2.5 MB/s                          â”‚
â”‚  å‰©ä½™æ—¶é—´: 8 ç§’                          â”‚
â”‚                                          â”‚
â”‚  [å–æ¶ˆä¸‹è½½]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€æ‰«æå’Œç´¢å¼•ç­–ç•¥è®¾è®¡

### 2.1 å…¨é‡æ‰«ææµç¨‹

```
ç”¨æˆ·è§¦å‘å…¨é‡æ‰«æ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰«æå‡†å¤‡é˜¶æ®µ                    â”‚
â”‚  1. è·å–æ‰€æœ‰å·¥ä½œåŒºåˆ—è¡¨           â”‚
â”‚  2. è·å–æ‰€æœ‰ä¼šè¯åˆ—è¡¨             â”‚
â”‚  3. ç»Ÿè®¡éœ€è¦ç´¢å¼•çš„æ¶ˆæ¯æ•°é‡       â”‚
â”‚  4. æ˜¾ç¤ºæ‰«æè®¡åˆ’                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ†æ‰¹å¤„ç†ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰        â”‚
â”‚  1. æŒ‰å·¥ä½œåŒºåˆ†æ‰¹                 â”‚
â”‚  2. æ¯æ‰¹å¤„ç† N ä¸ªä¼šè¯            â”‚
â”‚  3. æ¯ä¸ªä¼šè¯æå–æ¶ˆæ¯             â”‚
â”‚  4. æ‰¹é‡å‘é‡åŒ–ï¼ˆè°ƒç”¨ Embeddingï¼‰ â”‚
â”‚  5. æ‰¹é‡å†™å…¥ Qdrant             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿›åº¦è·Ÿè¸ª                       â”‚
â”‚  - å·²å¤„ç†ä¼šè¯æ•° / æ€»ä¼šè¯æ•°      â”‚
â”‚  - å·²ç´¢å¼•æ¶ˆæ¯æ•° / æ€»æ¶ˆæ¯æ•°      â”‚
â”‚  - å½“å‰å¤„ç†çš„å·¥ä½œåŒº              â”‚
â”‚  - é¢„è®¡å‰©ä½™æ—¶é—´                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å®Œæˆï¼Œæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
```

### 2.2 å¢é‡æ‰«æç­–ç•¥

#### ç­–ç•¥ï¼šå®šæ—¶æ‰«æä¼šè¯ç›®å½•ï¼ˆæ¨èï¼‰

```
å®šæ—¶æ‰«æ ~/.cursor/projects/ ç›®å½•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰«æä¼šè¯ç›®å½•                    â”‚
â”‚  1. éå†æ‰€æœ‰é¡¹ç›®ç›®å½•              â”‚
â”‚  2. æ‰«æ agent-transcripts/     â”‚
â”‚  3. æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´              â”‚
â”‚  4. å¯¹æ¯”å·²ç´¢å¼•çš„ç‰ˆæœ¬              â”‚
â”‚  5. è¯†åˆ«æ–°å¢/æ›´æ–°çš„ä¼šè¯æ–‡ä»¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¢é‡ç´¢å¼•                       â”‚
â”‚  1. åªå¤„ç†æ–°å¢/æ›´æ–°çš„ä¼šè¯æ–‡ä»¶     â”‚
â”‚  2. å¯¹äºæ›´æ–°çš„ä¼šè¯ï¼š             â”‚
â”‚     - ä½¿ç”¨ç›¸åŒçš„ vector_id       â”‚
â”‚     - ç›´æ¥è¦†ç›–å‘é‡ï¼ˆupsertï¼‰      â”‚
â”‚     - æ›´æ–°å…ƒæ•°æ®è¡¨               â”‚
â”‚  3. æ‰¹é‡å¤„ç†                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**ï¼š
- ç®€å•ç›´æ¥ï¼Œæ— éœ€ç›‘å¬æ•°æ®åº“
- é€šè¿‡æ–‡ä»¶ç³»ç»Ÿå˜åŒ–æ£€æµ‹æ›´æ–°
- è·¨å¹³å°å…¼å®¹æ€§å¥½
- èµ„æºå ç”¨ä½

### 2.3 æ‰«æé…ç½®é€‰é¡¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰«æè®¾ç½®                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  â˜‘ å¯ç”¨è‡ªåŠ¨æ‰«æ                          â”‚
â”‚                                          â”‚
â”‚  æ‰«æé¢‘ç‡:                               â”‚
â”‚  â—‹ æ¯å°æ—¶                                â”‚
â”‚  â—‹ æ¯ 2 å°æ—¶ï¼ˆæ¨èï¼‰                     â”‚
â”‚  â—‹ æ¯ 6 å°æ—¶                             â”‚
â”‚  â—‹ æ¯å¤©                                  â”‚
â”‚  â—‹ æ‰‹åŠ¨                                  â”‚
â”‚                                          â”‚
â”‚  è¯´æ˜: æ‰«æ ~/.cursor/projects/ ç›®å½•    â”‚
â”‚  æ£€æµ‹ä¼šè¯æ–‡ä»¶å˜åŒ–                        â”‚
â”‚                                          â”‚
â”‚  æ‰«æèŒƒå›´:                               â”‚
â”‚  â˜‘ æ‰€æœ‰å·¥ä½œåŒº                            â”‚
â”‚  â˜ ä»…å½“å‰å·¥ä½œåŒº                          â”‚
â”‚  â˜ æŒ‡å®šå·¥ä½œåŒºåˆ—è¡¨                        â”‚
â”‚                                          â”‚
â”‚  æ‰«æå†…å®¹:                               â”‚
â”‚  â˜‘ ç”¨æˆ·æ¶ˆæ¯                              â”‚
â”‚  â˜‘ AI å›å¤                               â”‚
â”‚  â˜ ä»£ç å—ï¼ˆå®éªŒæ€§ï¼‰                      â”‚
â”‚                                          â”‚
â”‚  é«˜çº§é€‰é¡¹:                               â”‚
â”‚  â€¢ æ‰¹é‡å¤§å°: [100] æ¡æ¶ˆæ¯/æ‰¹             â”‚
â”‚  â€¢ å¹¶å‘æ•°: [3] ä¸ªè¯·æ±‚                    â”‚
â”‚  â€¢ è·³è¿‡ç©ºæ¶ˆæ¯: â˜‘                        â”‚
â”‚  â€¢ æœ€å°æ¶ˆæ¯é•¿åº¦: [10] å­—ç¬¦               â”‚
â”‚                                          â”‚
â”‚  [ä¿å­˜è®¾ç½®] [ç«‹å³æ‰«æ]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸‰ã€æŠ€æœ¯å®ç°ç»†èŠ‚

### 3.0 Cursor ä¼šè¯å­˜å‚¨æœºåˆ¶ï¼ˆé‡è¦ï¼‰

#### ä¼šè¯å­˜å‚¨ç»“æ„

Cursor ä¼šè¯é‡‡ç”¨**åŒé‡å­˜å‚¨**æœºåˆ¶ï¼š

**1. ä¼šè¯å…ƒæ•°æ®ï¼ˆSQLite æ•°æ®åº“ï¼‰**
- **å…¨å±€å­˜å‚¨**: `~/.cursor/User/globalStorage/state.vscdb`
  - é”®: `composer.composerData`
  - å€¼: JSON æ•°ç»„ï¼ŒåŒ…å«æ‰€æœ‰ä¼šè¯çš„å…ƒæ•°æ®ï¼ˆComposerDataï¼‰
  - å­—æ®µ: `composerId`, `name`, `createdAt`, `lastUpdatedAt`, `totalLinesAdded`, ç­‰

- **å·¥ä½œåŒºå­˜å‚¨**: `~/.cursor/User/workspaceStorage/{workspaceId}/state.vscdb`
  - é”®: `composer.composerData`
  - å€¼: è¯¥å·¥ä½œåŒºçš„ä¼šè¯å…ƒæ•°æ®
  - æ³¨æ„: åŒä¸€é¡¹ç›®å¯èƒ½æœ‰å¤šä¸ªå·¥ä½œåŒºï¼Œæ¯ä¸ªå·¥ä½œåŒºæœ‰ç‹¬ç«‹çš„æ•°æ®åº“

**2. ä¼šè¯å†…å®¹ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰**
- **å­˜å‚¨è·¯å¾„**: `~/.cursor/projects/{projectKey}/agent-transcripts/{sessionId}.txt`
- **æ–‡ä»¶æ ¼å¼**: çº¯æ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«å®Œæ•´çš„å¯¹è¯å†…å®¹
- **æ–‡ä»¶å‘½å**: `{sessionId}.txt`ï¼ˆsessionId å°±æ˜¯ composerIdï¼‰
- **æ›´æ–°æœºåˆ¶**: ä¼šè¯æ›´æ–°æ—¶ï¼Œæ–‡ä»¶ä¼šè¢«é‡å†™ï¼ˆä¿®æ”¹æ—¶é—´ä¼šå˜åŒ–ï¼‰

**3. é¡¹ç›®ç»„ç»‡**
- **é¡¹ç›®ç›®å½•**: `~/.cursor/projects/{projectKey}/`
- **projectKey ç”Ÿæˆè§„åˆ™**: ä»é¡¹ç›®è·¯å¾„ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
  - ç¤ºä¾‹: `D:\code\cocursor` â†’ `d-code-cocursor`
  - è§„åˆ™: ç§»é™¤ `:`ï¼Œæ›¿æ¢è·¯å¾„åˆ†éš”ç¬¦ä¸º `-`ï¼Œè½¬å°å†™
- **é¡¹ç›®å‘ç°**: é€šè¿‡æ‰«æ `workspaceStorage` ç›®å½•ï¼Œè¯»å– `workspace.json` è·å–é¡¹ç›®è·¯å¾„

#### å­˜å‚¨å…³ç³»å›¾

```
~/.cursor/
â”œâ”€â”€ User/
â”‚   â”œâ”€â”€ globalStorage/
â”‚   â”‚   â””â”€â”€ state.vscdb          # å…¨å±€ä¼šè¯å…ƒæ•°æ®
â”‚   â””â”€â”€ workspaceStorage/
â”‚       â”œâ”€â”€ {workspaceId1}/
â”‚       â”‚   â”œâ”€â”€ workspace.json   # é¡¹ç›®è·¯å¾„: file:///d%3A/code/cocursor
â”‚       â”‚   â””â”€â”€ state.vscdb      # å·¥ä½œåŒºä¼šè¯å…ƒæ•°æ®
â”‚       â””â”€â”€ {workspaceId2}/
â”‚           â””â”€â”€ ...
â””â”€â”€ projects/
    â”œâ”€â”€ {projectKey1}/           # d-code-cocursor
    â”‚   â””â”€â”€ agent-transcripts/
    â”‚       â”œâ”€â”€ {sessionId1}.txt # ä¼šè¯å†…å®¹
    â”‚       â””â”€â”€ {sessionId2}.txt
    â””â”€â”€ {projectKey2}/
        â””â”€â”€ agent-transcripts/
            â””â”€â”€ ...
```

#### ç´¢å¼•ç­–ç•¥

åŸºäºå­˜å‚¨æœºåˆ¶ï¼ŒRAG ç´¢å¼•ç­–ç•¥ï¼š

1. **æ‰«ææº**: `~/.cursor/projects/{projectKey}/agent-transcripts/*.txt`
   - ç›´æ¥æ‰«ææ–‡ä»¶ç³»ç»Ÿï¼Œæ— éœ€è¯»å–æ•°æ®åº“
   - é€šè¿‡æ–‡ä»¶ä¿®æ”¹æ—¶é—´åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°ç´¢å¼•

2. **é¡¹ç›®å…³è”**:
   - ä» `projectKey`ï¼ˆç›®å½•åï¼‰è·å–é¡¹ç›®ä¿¡æ¯
   - é€šè¿‡ `ProjectManager` è·å– `ProjectID` å’Œ `ProjectName`
   - å¦‚æœé¡¹ç›®ä¿¡æ¯ä¸å­˜åœ¨ï¼Œä½¿ç”¨ `projectKey` ä½œä¸º `ProjectID`

3. **ä¼šè¯è¯†åˆ«**:
   - æ–‡ä»¶åå°±æ˜¯ `sessionId`ï¼ˆå»æ‰ `.txt` åç¼€ï¼‰
   - é€šè¿‡ `sessionId` å¯ä»¥æŸ¥è¯¢å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼Œç”¨äºè·å–æ›´å¤šä¿¡æ¯ï¼‰

4. **æ›´æ–°æ£€æµ‹**:
   - å¯¹æ¯”æ–‡ä»¶çš„ `ModTime()` å’Œå…ƒæ•°æ®è¡¨ä¸­çš„ `file_mtime`
   - å¦‚æœæ–‡ä»¶æ›´æ–°ï¼Œç›´æ¥è¦†ç›–ç´¢å¼•ï¼ˆä½¿ç”¨ç›¸åŒçš„ `vector_id`ï¼‰

#### æ’æŸ¥è¦ç‚¹

**é—®é¢˜æ’æŸ¥æ—¶éœ€è¦è€ƒè™‘**ï¼š

1. **æ–‡ä»¶ä¸å­˜åœ¨ä½†å…ƒæ•°æ®å­˜åœ¨**
   - å¯èƒ½åŸå› : ä¼šè¯å·²åˆ é™¤ï¼Œä½†æ•°æ®åº“æœªæ¸…ç†
   - å¤„ç†: è·³è¿‡ç´¢å¼•ï¼Œè®°å½•è­¦å‘Š

2. **æ–‡ä»¶å­˜åœ¨ä½†å…ƒæ•°æ®ä¸å­˜åœ¨**
   - å¯èƒ½åŸå› : æ–°ä¼šè¯ï¼Œæ•°æ®åº“è¿˜æœªåŒæ­¥
   - å¤„ç†: æ­£å¸¸ç´¢å¼•ï¼Œä½¿ç”¨æ–‡ä»¶æ—¶é—´ä½œä¸ºæ—¶é—´æˆ³

3. **é¡¹ç›®ä¿¡æ¯ç¼ºå¤±**
   - å¯èƒ½åŸå› : é¡¹ç›®è¿˜æœªè¢« `ProjectManager` å‘ç°
   - å¤„ç†: ä½¿ç”¨ `projectKey` ä½œä¸ºä¸´æ—¶é¡¹ç›®ä¿¡æ¯ï¼Œç­‰å¾…é¡¹ç›®å‘ç°åæ›´æ–°

4. **å¤šä¸ªå·¥ä½œåŒºå¯¹åº”åŒä¸€é¡¹ç›®**
   - å¯èƒ½åŸå› : åŒä¸€é¡¹ç›®åœ¨ä¸åŒæ—¶é—´æ‰“å¼€ï¼Œç”Ÿæˆä¸åŒå·¥ä½œåŒº ID
   - å¤„ç†: é€šè¿‡ `ProjectManager` ç»Ÿä¸€ç®¡ç†ï¼Œæ‰€æœ‰å·¥ä½œåŒºå…±äº«åŒä¸€ `ProjectID`

### 3.1 é…ç½®å­˜å‚¨

#### é…ç½®ç»“æ„

```go
type RAGConfig struct {
    // Embedding API é…ç½®
    EmbeddingAPI struct {
        URL      string `json:"url"`      // API URL
        APIKey   string `json:"api_key"`  // API Keyï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
        Model    string `json:"model"`     // æ¨¡å‹åç§°
        // æ³¨æ„: ä¸æŒ‡å®š providerï¼Œæ”¯æŒæ‰€æœ‰å…¼å®¹ OpenAI Embeddings API æ ¼å¼çš„ API
    } `json:"embedding_api"`
    
    // Qdrant é…ç½®
    Qdrant struct {
        Version     string `json:"version"`      // å·²ä¸‹è½½çš„ç‰ˆæœ¬
        BinaryPath  string `json:"binary_path"`  // äºŒè¿›åˆ¶è·¯å¾„
        DataPath    string `json:"data_path"`    // æ•°æ®å­˜å‚¨è·¯å¾„
        Collection  string `json:"collection"`   // é›†åˆåç§°
        VectorSize  int    `json:"vector_size"`  // å‘é‡ç»´åº¦
    } `json:"qdrant"`
    
    // æ‰«æé…ç½®
    ScanConfig struct {
        Enabled        bool   `json:"enabled"`         // æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ‰«æ
        Interval       string `json:"interval"`        // æ‰«æé—´éš”ï¼š1h/2h/6h/24h/manual
        BatchSize      int    `json:"batch_size"`      // æ‰¹é‡å¤§å°
        Concurrency    int    `json:"concurrency"`     // å¹¶å‘æ•°
        IncludeCode    bool   `json:"include_code"`    // æ˜¯å¦åŒ…å«ä»£ç å—
        MinMessageLen  int    `json:"min_message_len"` // æœ€å°æ¶ˆæ¯é•¿åº¦
    } `json:"scan_config"`
    
    // å…ƒæ•°æ®
    LastFullScan   int64 `json:"last_full_scan"`   // æœ€åå…¨é‡æ‰«ææ—¶é—´
    LastIncrementalScan int64 `json:"last_incremental_scan"` // æœ€åå¢é‡æ‰«ææ—¶é—´
    TotalIndexed   int   `json:"total_indexed"`    // å·²ç´¢å¼•æ¶ˆæ¯æ•°
}
```

#### é…ç½®å­˜å‚¨ä½ç½®

- **è·¯å¾„**: `~/.cocursor/rag_config.json`
- **åŠ å¯†**: API Key ä½¿ç”¨ç³»ç»Ÿå¯†é’¥åŠ å¯†å­˜å‚¨
- **å¤‡ä»½**: é…ç½®å˜æ›´æ—¶è‡ªåŠ¨å¤‡ä»½

### 3.2 Qdrant ç»„ä»¶ç®¡ç†

#### ä¸‹è½½ç­–ç•¥

```
æ£€æµ‹å¹³å°å’Œæ¶æ„
    â†“
æŸ¥è¯¢ GitHub Releases API è·å–æœ€æ–°ç¨³å®šç‰ˆ
ï¼ˆå½“å‰: v1.16.3ï¼Œ2024å¹´12æœˆï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ„å»ºä¸‹è½½ URL                    â”‚
â”‚  Windows:                       â”‚
â”‚    https://github.com/qdrant/   â”‚
â”‚    qdrant/releases/download/    â”‚
â”‚    v1.16.3/qdrant-1.16.3-       â”‚
â”‚    x86_64-pc-windows-msvc.zip  â”‚
â”‚                                 â”‚
â”‚  macOS:                         â”‚
â”‚    qdrant-1.16.3-x86_64-       â”‚
â”‚    apple-darwin.zip             â”‚
â”‚    (æˆ– arm64-apple-darwin)      â”‚
â”‚                                 â”‚
â”‚  Linux:                         â”‚
â”‚    qdrant-1.16.3-x86_64-       â”‚
â”‚    unknown-linux-musl.zip       â”‚
â”‚    (æˆ– aarch64-unknown-linux)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•
    â†“
éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼ˆSHA256ï¼‰
    â†“
è§£å‹åˆ° ~/.cocursor/bin/qdrant/
    â†“
è®¾ç½®æ‰§è¡Œæƒé™
    â†“
æµ‹è¯•è¿è¡Œï¼ˆqdrant --versionï¼‰
    â†“
è®°å½•ç‰ˆæœ¬å·åˆ°é…ç½®
```

#### ç‰ˆæœ¬ç®¡ç†

- **å›ºå®šç‰ˆæœ¬**: ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬ v1.16.3ï¼ˆ2024å¹´12æœˆï¼‰
- **ä¸æä¾›æ›´æ–°**: å›ºå®šä½¿ç”¨è¯¥ç‰ˆæœ¬ï¼Œä¸æ£€æŸ¥æˆ–æç¤ºæ›´æ–°
- **ç‰ˆæœ¬æŸ¥è¯¢**: é¦–æ¬¡ä¸‹è½½æ—¶é€šè¿‡ GitHub API è·å–æœ€æ–°ç¨³å®šç‰ˆæ ‡ç­¾
- **ç‰ˆæœ¬è®°å½•**: ä¸‹è½½åè®°å½•ç‰ˆæœ¬å·åˆ°é…ç½®æ–‡ä»¶ï¼Œåç»­ç›´æ¥ä½¿ç”¨

### 3.3 æ‰«æä»»åŠ¡è°ƒåº¦

#### ä»»åŠ¡é˜Ÿåˆ—è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰«æä»»åŠ¡é˜Ÿåˆ—                    â”‚
â”‚  - å…¨é‡æ‰«æä»»åŠ¡ï¼ˆä¼˜å…ˆçº§ä½ï¼‰      â”‚
â”‚  - å¢é‡æ‰«æä»»åŠ¡ï¼ˆä¼˜å…ˆçº§ä¸­ï¼‰      â”‚
â”‚  - å®æ—¶ç´¢å¼•ä»»åŠ¡ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡æ‰§è¡Œå™¨                      â”‚
â”‚  - å¹¶å‘æ§åˆ¶ï¼ˆæœ€å¤š N ä¸ªä»»åŠ¡ï¼‰    â”‚
â”‚  - é‡è¯•æœºåˆ¶ï¼ˆå¤±è´¥è‡ªåŠ¨é‡è¯•ï¼‰     â”‚
â”‚  - è¿›åº¦è·Ÿè¸ª                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®šæ—¶ä»»åŠ¡å®ç°

```go
// æ‰«æä¼šè¯ç›®å½•: ~/.cursor/projects/
// å®šæ—¶ä»»åŠ¡é—´éš”ï¼ˆå¯é…ç½®ï¼‰:
//   - æ¯å°æ—¶: 1 * time.Hour
//   - æ¯ 2 å°æ—¶: 2 * time.Hour
//   - æ¯ 6 å°æ—¶: 6 * time.Hour
//   - æ¯å¤©: 24 * time.Hour

type ScanScheduler struct {
    ticker      *time.Ticker
    ragService  *RAGService
    projectsDir string  // ~/.cursor/projects/
}

func (s *ScanScheduler) Start() {
    if !config.ScanConfig.Enabled {
        return
    }
    
    // æ ¹æ®é…ç½®è®¾ç½®æ‰«æé—´éš”
    interval := parseInterval(config.ScanConfig.Interval)
    s.ticker = time.NewTicker(interval)
    
    go func() {
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        s.scanProjectsDir()
        
        // å®šæ—¶æ‰§è¡Œ
        for range s.ticker.C {
            s.scanProjectsDir()
        }
    }()
}

func (s *ScanScheduler) scanProjectsDir() {
    // æ‰«æ ~/.cursor/projects/ ç›®å½•
    // 1. éå†æ‰€æœ‰é¡¹ç›®ç›®å½•
    // 2. æ£€æŸ¥ agent-transcripts/ ç›®å½•
    // 3. å¯¹æ¯”æ–‡ä»¶ä¿®æ”¹æ—¶é—´
    // 4. è¯†åˆ«éœ€è¦ç´¢å¼•çš„ä¼šè¯æ–‡ä»¶
    // 5. è°ƒç”¨ RAG æœåŠ¡è¿›è¡Œç´¢å¼•
}
```

### 3.4 ç´¢å¼•æ•°æ®ç»“æ„

#### Qdrant Collection ç»“æ„ï¼ˆæ··åˆç­–ç•¥ï¼‰

**Collection 1: æ¶ˆæ¯çº§åˆ«ç´¢å¼•**
```json
{
  "collection_name": "cursor_sessions_messages",
  "vector_size": 1536,  // æ ¹æ®æ¨¡å‹è°ƒæ•´
  "distance": "Cosine",
  "points": [
    {
      "id": "composer-xxx:msg-0",  // æ ¼å¼: {session_id}:{message_id}
      "vector": [0.1, 0.2, ...],
      "payload": {
        "session_id": "composer-xxx",
        "message_id": "composer-xxx-0-1704067200000",
        "message_type": "user|ai",
        "content": "æ¶ˆæ¯å†…å®¹",
        "timestamp": 1234567890,
        "message_index": 0,         // æ¶ˆæ¯åœ¨ä¼šè¯ä¸­çš„ä½ç½®
        "turn_index": 0,            // æ‰€å±å¯¹è¯å¯¹ç´¢å¼•
        "workspace_id": "workspace-xxx",
        "project_id": "project-key",
        "project_name": "project-name"
      }
    }
  ]
}
```

**Collection 2: å¯¹è¯å¯¹çº§åˆ«ç´¢å¼•**
```json
{
  "collection_name": "cursor_sessions_turns",
  "vector_size": 1536,
  "distance": "Cosine",
  "points": [
    {
      "id": "composer-xxx:turn-0",  // æ ¼å¼: {session_id}:turn-{index}
      "vector": [0.3, 0.4, ...],
      "payload": {
        "session_id": "composer-xxx",
        "turn_index": 0,
        "user_text": "ç”¨æˆ·æ¶ˆæ¯å†…å®¹ï¼ˆå¯èƒ½åˆå¹¶å¤šæ¡ï¼‰",
        "ai_text": "AI å›å¤å†…å®¹ï¼ˆå¯èƒ½åˆå¹¶å¤šæ¡ï¼‰",
        "combined_text": "ç”¨æˆ·: ...\n\nAI: ...",  // å®Œæ•´å¯¹è¯å¯¹æ–‡æœ¬
        "user_message_ids": ["msg-0", "msg-1"],   // ç”¨æˆ·æ¶ˆæ¯ ID åˆ—è¡¨
        "ai_message_ids": ["msg-2", "msg-3"],     // AI æ¶ˆæ¯ ID åˆ—è¡¨
        "message_count": 4,                       // æ€»æ¶ˆæ¯æ•°
        "timestamp": 1234567890,                  // å¯¹è¯å¯¹å¼€å§‹æ—¶é—´
        "workspace_id": "workspace-xxx",
        "project_id": "project-key",
        "project_name": "project-name"
      }
    }
  ]
}
```

**å…³é”®è®¾è®¡**ï¼š
- **æ¶ˆæ¯çº§åˆ«**ï¼šæ¯æ¡æ¶ˆæ¯ä¸€ä¸ªå‘é‡ï¼Œç”¨äºç²¾ç¡®åŒ¹é…
- **å¯¹è¯å¯¹çº§åˆ«**ï¼šæ¯ä¸ªå¯¹è¯å¯¹ä¸€ä¸ªå‘é‡ï¼Œç”¨äºä¸Šä¸‹æ–‡ç†è§£
- **ID æ ¼å¼**ï¼š
  - æ¶ˆæ¯: `{session_id}:{message_id}`
  - å¯¹è¯å¯¹: `{session_id}:turn-{index}`
- **å…³è”å…³ç³»**ï¼šé€šè¿‡ `turn_index` å’Œ `message_ids` å…³è”æ¶ˆæ¯å’Œå¯¹è¯å¯¹

#### ç´¢å¼•å…ƒæ•°æ®è¡¨ï¼ˆSQLiteï¼Œæ··åˆç­–ç•¥ï¼‰

**è¡¨ 1: æ¶ˆæ¯çº§åˆ«å…ƒæ•°æ®**
```sql
CREATE TABLE rag_message_metadata (
    session_id TEXT NOT NULL,
    message_id TEXT NOT NULL,         -- æ ¼å¼: {session_id}-{index}-{timestamp}
    workspace_id TEXT NOT NULL,
    project_id TEXT NOT NULL,
    project_name TEXT NOT NULL,
    message_type TEXT NOT NULL,       -- 'user' or 'ai'
    message_index INTEGER NOT NULL,   -- æ¶ˆæ¯åœ¨ä¼šè¯ä¸­çš„ä½ç½®
    turn_index INTEGER NOT NULL,      -- æ‰€å±å¯¹è¯å¯¹ç´¢å¼•
    indexed_at INTEGER NOT NULL,
    vector_id TEXT NOT NULL,          -- Qdrant ä¸­çš„ IDï¼ˆæ ¼å¼: {session_id}:{message_id}ï¼‰
    content_hash TEXT NOT NULL,       -- æ¶ˆæ¯å†…å®¹å“ˆå¸Œ
    file_path TEXT NOT NULL,
    file_mtime INTEGER NOT NULL,
    PRIMARY KEY (session_id, message_id)
);

CREATE INDEX idx_rag_msg_workspace ON rag_message_metadata(workspace_id);
CREATE INDEX idx_rag_msg_project ON rag_message_metadata(project_id);
CREATE INDEX idx_rag_msg_turn ON rag_message_metadata(session_id, turn_index);
CREATE INDEX idx_rag_msg_vector_id ON rag_message_metadata(vector_id);
```

**è¡¨ 2: å¯¹è¯å¯¹çº§åˆ«å…ƒæ•°æ®**
```sql
CREATE TABLE rag_turn_metadata (
    session_id TEXT NOT NULL,
    turn_index INTEGER NOT NULL,      -- å¯¹è¯å¯¹åœ¨ä¼šè¯ä¸­çš„ç´¢å¼•
    workspace_id TEXT NOT NULL,
    project_id TEXT NOT NULL,
    project_name TEXT NOT NULL,
    user_message_ids TEXT NOT NULL,   -- JSON æ•°ç»„: ["msg-0", "msg-1"]
    ai_message_ids TEXT NOT NULL,     -- JSON æ•°ç»„: ["msg-2", "msg-3"]
    message_count INTEGER NOT NULL,   -- æ€»æ¶ˆæ¯æ•°
    indexed_at INTEGER NOT NULL,
    vector_id TEXT NOT NULL,          -- Qdrant ä¸­çš„ IDï¼ˆæ ¼å¼: {session_id}:turn-{index}ï¼‰
    content_hash TEXT NOT NULL,       -- å¯¹è¯å¯¹å†…å®¹å“ˆå¸Œ
    file_path TEXT NOT NULL,
    file_mtime INTEGER NOT NULL,
    PRIMARY KEY (session_id, turn_index)
);

CREATE INDEX idx_rag_turn_workspace ON rag_turn_metadata(workspace_id);
CREATE INDEX idx_rag_turn_project ON rag_turn_metadata(project_id);
CREATE INDEX idx_rag_turn_vector_id ON rag_turn_metadata(vector_id);
```

**å…³é”®è®¾è®¡**ï¼š
- `message_id`: æ ¼å¼ `{session_id}-{index}-{timestamp}`ï¼Œç¡®ä¿å”¯ä¸€æ€§
  - ç¤ºä¾‹: `composer-xxx-0-1234567890`ï¼ˆä¼šè¯ID-ä½ç½®ç´¢å¼•-æ—¶é—´æˆ³ï¼‰
- `vector_id`: å›ºå®šæ ¼å¼ `{session_id}:{message_id}`ï¼Œç¡®ä¿æ›´æ–°æ—¶å¯ä»¥ç›´æ¥è¦†ç›–
- `project_id`: ç”¨äºå¿«é€Ÿè¿‡æ»¤æŸ¥è¯¢
- `file_path` å’Œ `file_mtime`: ç”¨äºæ£€æµ‹æ–‡ä»¶å˜åŒ–ï¼Œå†³å®šæ˜¯å¦éœ€è¦é‡æ–°ç´¢å¼•
- `content_hash`: æ–‡ä»¶å†…å®¹å“ˆå¸Œï¼Œç”¨äºæ£€æµ‹å†…å®¹æ˜¯å¦çœŸæ­£å˜åŒ–

#### æ¶ˆæ¯ ID ç”Ÿæˆè§„åˆ™

**é—®é¢˜**: transcript æ–‡ä»¶ä¸­çš„æ¶ˆæ¯æ²¡æœ‰æ˜ç¡®çš„ message_id

**è§£å†³æ–¹æ¡ˆ**: åŸºäºæ¶ˆæ¯åœ¨ä¼šè¯ä¸­çš„ä½ç½®å’Œæ—¶é—´æˆ³ç”Ÿæˆå”¯ä¸€ ID

```go
// message_id ç”Ÿæˆè§„åˆ™
messageID := fmt.Sprintf("%s-%d-%d", sessionID, messageIndex, messageTimestamp)

// ç¤ºä¾‹:
// sessionID: "composer-abc123"
// messageIndex: 0 (ç¬¬ä¸€æ¡æ¶ˆæ¯)
// messageTimestamp: 1704067200000 (æ¯«ç§’æ—¶é—´æˆ³)
// ç»“æœ: "composer-abc123-0-1704067200000"

// vector_id ç”Ÿæˆè§„åˆ™
vectorID := fmt.Sprintf("%s:%s", sessionID, messageID)

// ç¤ºä¾‹:
// sessionID: "composer-abc123"
// messageID: "composer-abc123-0-1704067200000"
// ç»“æœ: "composer-abc123:composer-abc123-0-1704067200000"
```

**ä¼˜åŠ¿**ï¼š
- å”¯ä¸€æ€§ï¼šsessionID + index + timestamp ä¿è¯å”¯ä¸€
- ç¨³å®šæ€§ï¼šç›¸åŒä½ç½®å’Œæ—¶é—´æˆ³çš„æ¶ˆæ¯ ID ä¸å˜ï¼ˆæ”¯æŒè¦†ç›–æ›´æ–°ï¼‰
- å¯è¯»æ€§ï¼šID ä¸­åŒ…å«ä½ç½®ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•

#### å®Œæ•´ç´¢å¼•æµç¨‹ï¼ˆå•ä¸ªä¼šè¯ï¼Œæ··åˆç­–ç•¥ï¼‰

```
æ‰«æåˆ°ä¼šè¯æ–‡ä»¶: ~/.cursor/projects/{projectKey}/agent-transcripts/{sessionId}.txt
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1: è¯»å–ä¼šè¯å†…å®¹                    â”‚
â”‚  - è¯»å– transcript æ–‡ä»¶                 â”‚
â”‚  - è§£æä¸º Message åˆ—è¡¨                  â”‚
â”‚  - è¿‡æ»¤ç©ºæ¶ˆæ¯ã€ä»£ç å—ï¼ˆä¿ç•™ tool callï¼‰ â”‚
â”‚  ç»“æœ: []Message                        â”‚
â”‚    - Type: user|ai                      â”‚
â”‚    - Text: æ–‡æœ¬å†…å®¹ï¼ˆå·²è¿‡æ»¤ tool resultï¼‰â”‚
â”‚    - Tools: []ToolCall (ä»… AI æ¶ˆæ¯)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2: ç”Ÿæˆæ¶ˆæ¯ ID                     â”‚
â”‚  éå†æ¯æ¡æ¶ˆæ¯:                           â”‚
â”‚  for i, msg := range messages {         â”‚
â”‚      messageID = fmt.Sprintf(           â”‚
â”‚          "%s-%d-%d",                    â”‚
â”‚          sessionID, i, msg.Timestamp   â”‚
â”‚      )                                  â”‚
â”‚  }                                      â”‚
â”‚  ç»“æœ: []IndexedMessage                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3: é…å¯¹æ¶ˆæ¯ä¸ºå¯¹è¯å¯¹                 â”‚
â”‚  - åˆå¹¶è¿ç»­çš„ç”¨æˆ·æ¶ˆæ¯                    â”‚
â”‚  - åˆå¹¶è¿ç»­çš„ AI æ¶ˆæ¯                    â”‚
â”‚  - æ”¶é›†æ‰€æœ‰ tool call                   â”‚
â”‚  ç»“æœ: []ConversationTurn                â”‚
â”‚    - UserMessages: []Message            â”‚
â”‚    - AIMessages: []Message              â”‚
â”‚    - CombinedText: "ç”¨æˆ·: ...\n\nAI: ..."â”‚
â”‚    - Tools: []ToolCall                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 4: æå–æ–‡æœ¬å†…å®¹                    â”‚
â”‚  - æ¶ˆæ¯çº§åˆ«: æ¯æ¡æ¶ˆæ¯çš„æ–‡æœ¬              â”‚
â”‚  - å¯¹è¯å¯¹çº§åˆ«: å¯¹è¯å¯¹çš„åˆå¹¶æ–‡æœ¬          â”‚
â”‚  - è¿‡æ»¤ç©ºæ¶ˆæ¯å’Œè¿‡çŸ­æ¶ˆæ¯                  â”‚
â”‚  ç»“æœ:                                   â”‚
â”‚    - MessageTexts: []string             â”‚
â”‚    - TurnTexts: []string                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 5: æ‰¹é‡å‘é‡åŒ–                      â”‚
â”‚  - æ¶ˆæ¯çº§åˆ«å‘é‡åŒ–                        â”‚
â”‚  - å¯¹è¯å¯¹çº§åˆ«å‘é‡åŒ–                      â”‚
â”‚  - æ‰¹é‡å¤„ç†ï¼ˆå‡å°‘è¯·æ±‚æ•°ï¼‰                â”‚
â”‚  ç»“æœ:                                   â”‚
â”‚    - MessageVectors: [][]float32         â”‚
â”‚    - TurnVectors: [][]float32            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 6: æ„å»º Qdrant ç‚¹                  â”‚
â”‚                                          â”‚
â”‚  6.1 æ¶ˆæ¯çº§åˆ«ç‚¹:                         â”‚
â”‚  for i, im := range indexedMessages {   â”‚
â”‚      point = {                          â”‚
â”‚          id: "{session_id}:{message_id}",â”‚
â”‚          vector: messageVectors[i],      â”‚
â”‚          payload: {                     â”‚
â”‚              session_id, message_id,    â”‚
â”‚              message_type, content,     â”‚
â”‚              turn_index, ...            â”‚
â”‚          }                              â”‚
â”‚      }                                  â”‚
â”‚  }                                      â”‚
â”‚                                          â”‚
â”‚  6.2 å¯¹è¯å¯¹çº§åˆ«ç‚¹:                       â”‚
â”‚  for i, turn := range turns {           â”‚
â”‚      point = {                           â”‚
â”‚          id: "{session_id}:turn-{i}",   â”‚
â”‚          vector: turnVectors[i],         â”‚
â”‚          payload: {                     â”‚
â”‚              session_id, turn_index,    â”‚
â”‚              user_text, ai_text,        â”‚
â”‚              combined_text,             â”‚
â”‚              user_message_ids,          â”‚
â”‚              ai_message_ids,            â”‚
â”‚              tools, ...                  â”‚
â”‚          }                              â”‚
â”‚      }                                  â”‚
â”‚  }                                      â”‚
â”‚  ç»“æœ:                                   â”‚
â”‚    - MessagePoints: []PointStruct        â”‚
â”‚    - TurnPoints: []PointStruct          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 7: å†™å…¥ Qdrant                     â”‚
â”‚  - Collection: cursor_sessions_messages  â”‚
â”‚  - Collection: cursor_sessions_turns     â”‚
â”‚  - Upsert æ“ä½œï¼ˆè¦†ç›–å·²å­˜åœ¨çš„ç‚¹ï¼‰         â”‚
â”‚  - æ‰¹é‡å†™å…¥ï¼ˆæé«˜æ€§èƒ½ï¼‰                  â”‚
â”‚  ç»“æœ: å‘é‡å·²å­˜å‚¨åˆ° Qdrant              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 8: æ›´æ–°å…ƒæ•°æ®è¡¨                     â”‚
â”‚                                          â”‚
â”‚  8.1 æ¶ˆæ¯çº§åˆ«å…ƒæ•°æ®:                      â”‚
â”‚  for _, im := range indexedMessages {   â”‚
â”‚      INSERT INTO rag_message_metadata  â”‚
â”‚  }                                      â”‚
â”‚                                          â”‚
â”‚  8.2 å¯¹è¯å¯¹çº§åˆ«å…ƒæ•°æ®:                    â”‚
â”‚  for _, turn := range turns {           â”‚
â”‚      INSERT INTO rag_turn_metadata      â”‚
â”‚  }                                      â”‚
â”‚  ç»“æœ: å…ƒæ•°æ®å·²è®°å½•                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç´¢å¼•å®Œæˆ âœ…
```

#### ç¤ºä¾‹ï¼šä¸€ä¸ªä¼šè¯çš„ç´¢å¼•è¿‡ç¨‹ï¼ˆæ··åˆç­–ç•¥ï¼‰

**è¾“å…¥**ï¼š
- ä¼šè¯æ–‡ä»¶: `~/.cursor/projects/d-code-cocursor/agent-transcripts/composer-abc123.txt`
- ä¼šè¯å†…å®¹ï¼ˆçœŸå®åœºæ™¯ï¼‰:
  ```
  user: å¦‚ä½•è®¾è®¡ RAG åŠŸèƒ½ï¼Ÿ
  user: éœ€è¦è€ƒè™‘å“ªäº›å› ç´ ï¼Ÿ
  assistant: éœ€è¦å‘é‡åº“å’ŒåµŒå…¥æ¨¡å‹
  [Tool call] read_file
  path: /path/to/file
  [Tool result]
  æ–‡ä»¶å†…å®¹...
  assistant: æ¨èä½¿ç”¨ Qdrant åµŒå…¥å¼æ¨¡å¼
  user: å¦‚ä½•ä¿è¯è·¨å¹³å°å…¼å®¹ï¼Ÿ
  assistant: éœ€è¦è‡ªåŠ¨ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶
  ```

**å¤„ç†è¿‡ç¨‹**ï¼š

1. **è¯»å–æ¶ˆæ¯** (6 æ¡æ¶ˆæ¯)
   ```
   Message[0]: Type=user, Text="å¦‚ä½•è®¾è®¡ RAG åŠŸèƒ½ï¼Ÿ", Timestamp=1704067200000
   Message[1]: Type=user, Text="éœ€è¦è€ƒè™‘å“ªäº›å› ç´ ï¼Ÿ", Timestamp=1704067201000
   Message[2]: Type=ai, Text="éœ€è¦å‘é‡åº“å’ŒåµŒå…¥æ¨¡å‹", Timestamp=1704067202000, Tools=[read_file]
   Message[3]: Type=ai, Text="æ¨èä½¿ç”¨ Qdrant åµŒå…¥å¼æ¨¡å¼", Timestamp=1704067203000
   Message[4]: Type=user, Text="å¦‚ä½•ä¿è¯è·¨å¹³å°å…¼å®¹ï¼Ÿ", Timestamp=1704067204000
   Message[5]: Type=ai, Text="éœ€è¦è‡ªåŠ¨ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶", Timestamp=1704067205000
   ```

2. **ç”Ÿæˆæ¶ˆæ¯ ID**
   ```
   IndexedMessage[0]: MessageID="composer-abc123-0-1704067200000"
   IndexedMessage[1]: MessageID="composer-abc123-1-1704067201000"
   IndexedMessage[2]: MessageID="composer-abc123-2-1704067202000"
   IndexedMessage[3]: MessageID="composer-abc123-3-1704067203000"
   IndexedMessage[4]: MessageID="composer-abc123-4-1704067204000"
   IndexedMessage[5]: MessageID="composer-abc123-5-1704067205000"
   ```

3. **é…å¯¹ä¸ºå¯¹è¯å¯¹** (2 ä¸ªå¯¹è¯å¯¹)
   ```
   Turn[0]:
     UserMessages: [0, 1]  // åˆå¹¶ä¸¤æ¡ç”¨æˆ·æ¶ˆæ¯
     AIMessages: [2, 3]     // åˆå¹¶ä¸¤æ¡ AI æ¶ˆæ¯
     CombinedText: "ç”¨æˆ·: å¦‚ä½•è®¾è®¡ RAG åŠŸèƒ½ï¼Ÿ\n\néœ€è¦è€ƒè™‘å“ªäº›å› ç´ ï¼Ÿ\n\nAI: éœ€è¦å‘é‡åº“å’ŒåµŒå…¥æ¨¡å‹\n\næ¨èä½¿ç”¨ Qdrant åµŒå…¥å¼æ¨¡å¼"
     Tools: [read_file]
   
   Turn[1]:
     UserMessages: [4]
     AIMessages: [5]
     CombinedText: "ç”¨æˆ·: å¦‚ä½•ä¿è¯è·¨å¹³å°å…¼å®¹ï¼Ÿ\n\nAI: éœ€è¦è‡ªåŠ¨ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶"
   ```

4. **å‘é‡åŒ–** (æ¶ˆæ¯çº§åˆ« + å¯¹è¯å¯¹çº§åˆ«)
   ```
   æ¶ˆæ¯çº§åˆ«å‘é‡ (6ä¸ª):
     MessageVector[0]: [0.1, 0.2, ...]  // ç”¨æˆ·æ¶ˆæ¯[0]
     MessageVector[1]: [0.15, 0.25, ...] // ç”¨æˆ·æ¶ˆæ¯[1]
     MessageVector[2]: [0.3, 0.1, ...]   // AI æ¶ˆæ¯[2]
     MessageVector[3]: [0.35, 0.15, ...] // AI æ¶ˆæ¯[3]
     MessageVector[4]: [0.2, 0.4, ...]   // ç”¨æˆ·æ¶ˆæ¯[4]
     MessageVector[5]: [0.4, 0.3, ...]   // AI æ¶ˆæ¯[5]
   
   å¯¹è¯å¯¹çº§åˆ«å‘é‡ (2ä¸ª):
     TurnVector[0]: [0.25, 0.2, ...]  // Turn[0] çš„åˆå¹¶å‘é‡
     TurnVector[1]: [0.3, 0.35, ...] // Turn[1] çš„åˆå¹¶å‘é‡
   ```

5. **å­˜å‚¨åˆ° Qdrant** (8 ä¸ªç‚¹)
   ```
   æ¶ˆæ¯çº§åˆ« (6ä¸ªç‚¹):
     Point[0]: id="composer-abc123:msg-0", vector=MessageVector[0], payload={...}
     Point[1]: id="composer-abc123:msg-1", vector=MessageVector[1], payload={...}
     Point[2]: id="composer-abc123:msg-2", vector=MessageVector[2], payload={..., tools: [read_file]}
     Point[3]: id="composer-abc123:msg-3", vector=MessageVector[3], payload={...}
     Point[4]: id="composer-abc123:msg-4", vector=MessageVector[4], payload={...}
     Point[5]: id="composer-abc123:msg-5", vector=MessageVector[5], payload={...}
   
   å¯¹è¯å¯¹çº§åˆ« (2ä¸ªç‚¹):
     Point[0]: id="composer-abc123:turn-0", vector=TurnVector[0], 
              payload={user_text, ai_text, combined_text, user_message_ids: [msg-0, msg-1], ai_message_ids: [msg-2, msg-3], tools: [read_file]}
     Point[1]: id="composer-abc123:turn-1", vector=TurnVector[1],
              payload={user_text, ai_text, combined_text, user_message_ids: [msg-4], ai_message_ids: [msg-5]}
   ```

6. **æ›´æ–°å…ƒæ•°æ®è¡¨** (8 æ¡è®°å½•)
   ```sql
   -- æ¶ˆæ¯çº§åˆ«å…ƒæ•°æ® (6æ¡)
   INSERT INTO rag_message_metadata VALUES
   ('composer-abc123', 'msg-0', ..., turn_index=0, ...),
   ('composer-abc123', 'msg-1', ..., turn_index=0, ...),
   ('composer-abc123', 'msg-2', ..., turn_index=0, ...),
   ('composer-abc123', 'msg-3', ..., turn_index=0, ...),
   ('composer-abc123', 'msg-4', ..., turn_index=1, ...),
   ('composer-abc123', 'msg-5', ..., turn_index=1, ...);
   
   -- å¯¹è¯å¯¹çº§åˆ«å…ƒæ•°æ® (2æ¡)
   INSERT INTO rag_turn_metadata VALUES
   ('composer-abc123', 0, ..., user_message_ids='["msg-0","msg-1"]', ai_message_ids='["msg-2","msg-3"]', ...),
   ('composer-abc123', 1, ..., user_message_ids='["msg-4"]', ai_message_ids='["msg-5"]', ...);
   ```

**ç»“æœ**ï¼š
- Qdrant ä¸­å­˜å‚¨äº† 8 ä¸ªå‘é‡ç‚¹ï¼ˆ6 ä¸ªæ¶ˆæ¯çº§åˆ« + 2 ä¸ªå¯¹è¯å¯¹çº§åˆ«ï¼‰
- å…ƒæ•°æ®è¡¨ä¸­è®°å½•äº† 8 æ¡ç´¢å¼•è®°å½•
- æ”¯æŒæ¶ˆæ¯çº§åˆ«ç²¾ç¡®æœç´¢å’Œå¯¹è¯å¯¹çº§åˆ«ä¸Šä¸‹æ–‡æœç´¢
- æ”¯æŒæŒ‰é¡¹ç›®è¿‡æ»¤

### 3.5 æœç´¢æ¥å£è®¾è®¡

#### æœç´¢è¯·æ±‚ç»“æ„

```go
type SearchRequest struct {
    Query      string   `json:"query"`       // æœç´¢æŸ¥è¯¢æ–‡æœ¬
    Limit      int      `json:"limit"`       // è¿”å›ç»“æœæ•°é‡ï¼ˆé»˜è®¤ 10ï¼‰
    ProjectIDs []string `json:"project_ids"` // é¡¹ç›® ID åˆ—è¡¨ï¼ˆå¯é€‰ï¼Œç©ºè¡¨ç¤ºæ‰€æœ‰é¡¹ç›®ï¼‰
    Filters    *SearchFilters `json:"filters,omitempty"` // å…¶ä»–è¿‡æ»¤æ¡ä»¶
}

type SearchFilters struct {
    MessageType string `json:"message_type,omitempty"` // user|ai|all
    StartTime   int64  `json:"start_time,omitempty"`  // å¼€å§‹æ—¶é—´æˆ³
    EndTime     int64  `json:"end_time,omitempty"`     // ç»“æŸæ—¶é—´æˆ³
}
```

#### æœç´¢å“åº”ç»“æ„

```go
type SearchResponse struct {
    Results []SearchResult `json:"results"`
    Total   int           `json:"total"`   // æ€»ç»“æœæ•°
}

type SearchResult struct {
    Score       float64 `json:"score"`        // ç›¸ä¼¼åº¦åˆ†æ•°
    SessionID   string  `json:"session_id"`   // ä¼šè¯ ID
    ResultType  string  `json:"result_type"`  // "turn" æˆ– "message"
    
    // å¯¹è¯å¯¹ç±»å‹å­—æ®µ
    TurnIndex   int     `json:"turn_index,omitempty"`   // å¯¹è¯å¯¹ç´¢å¼•
    UserText    string  `json:"user_text,omitempty"`    // ç”¨æˆ·æ¶ˆæ¯æ–‡æœ¬
    AIText      string  `json:"ai_text,omitempty"`      // AI å›å¤æ–‡æœ¬
    CombinedText string `json:"combined_text,omitempty"` // å®Œæ•´å¯¹è¯å¯¹æ–‡æœ¬
    
    // æ¶ˆæ¯ç±»å‹å­—æ®µ
    MessageID   string  `json:"message_id,omitempty"`   // æ¶ˆæ¯ ID
    Content     string  `json:"content,omitempty"`      // æ¶ˆæ¯å†…å®¹
    MessageType string  `json:"message_type,omitempty"` // user|ai
    
    // é€šç”¨å­—æ®µ
    Timestamp   int64   `json:"timestamp"`    // æ—¶é—´æˆ³
    ProjectID   string  `json:"project_id"`   // é¡¹ç›® ID
    ProjectName string  `json:"project_name"` // é¡¹ç›®åç§°
    WorkspaceID string  `json:"workspace_id"` // å·¥ä½œåŒº ID
}
```

#### æœç´¢å®ç°é€»è¾‘ï¼ˆæ··åˆç­–ç•¥ï¼‰

```go
func (s *RAGService) Search(req SearchRequest) (*SearchResponse, error) {
    // 1. ç”ŸæˆæŸ¥è¯¢å‘é‡
    queryVector, err := s.embeddingService.EmbedText(req.Query)
    if err != nil {
        return nil, fmt.Errorf("failed to embed query: %w", err)
    }
    
    // 2. æ„å»ºé¡¹ç›®è¿‡æ»¤æ¡ä»¶ï¼ˆå¦‚æœæŒ‡å®šï¼‰
    var projectFilter *qdrant.Filter
    if len(req.ProjectIDs) > 0 {
        projectFilter = &qdrant.Filter{
            Must: []*qdrant.Condition{
                {
                    Condition: &qdrant.Condition_Field{
                        Field: &qdrant.FieldCondition{
                            Key: "project_id",
                            Match: &qdrant.Match{
                                MatchValue: &qdrant.Match_Any{
                                    Any: &qdrant.RepeatedStrings{
                                        Strings: req.ProjectIDs,
                                    },
                                },
                            },
                        },
                    },
                },
            },
        }
    }
    
    // 3. å¯¹è¯å¯¹çº§åˆ«æœç´¢ï¼ˆä¼˜å…ˆï¼Œè·å–ä¸Šä¸‹æ–‡ï¼‰
    turnResults, err := s.searchTurns(queryVector, projectFilter, req.Limit*2)
    if err != nil {
        log.Printf("turn search failed: %v", err)
        turnResults = []*SearchResult{}
    }
    
    // 4. æ¶ˆæ¯çº§åˆ«æœç´¢ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
    messageResults, err := s.searchMessages(queryVector, projectFilter, req.Limit*2)
    if err != nil {
        log.Printf("message search failed: %v", err)
        messageResults = []*SearchResult{}
    }
    
    // 5. åˆå¹¶å’Œå»é‡
    merged := s.mergeResults(turnResults, messageResults)
    
    // 6. é‡æ–°æ’åºï¼ˆå¯¹è¯å¯¹ä¼˜å…ˆï¼Œå› ä¸ºåŒ…å«æ›´å¤šä¸Šä¸‹æ–‡ï¼‰
    sorted := s.sortByRelevance(merged, req.Query)
    
    // 7. è¿”å› Top-K
    limit := req.Limit
    if limit <= 0 {
        limit = 10
    }
    if len(sorted) > limit {
        sorted = sorted[:limit]
    }
    
    return &SearchResponse{
        Results: sorted,
        Total:   len(sorted),
    }, nil
}

// æœç´¢å¯¹è¯å¯¹çº§åˆ«
func (s *RAGService) searchTurns(queryVector []float32, filter *qdrant.Filter, limit int) ([]*SearchResult, error) {
    query := &qdrant.SearchPoints{
        CollectionName: "cursor_sessions_turns",
        Vector:         queryVector,
        Limit:          uint64(limit),
        WithPayload:    true,
        Filter:         filter,
    }
    
    results, err := s.qdrantClient.Search(query)
    if err != nil {
        return nil, err
    }
    
    // è½¬æ¢ä¸º SearchResultï¼ˆæ ‡è®°ä¸ºå¯¹è¯å¯¹ç±»å‹ï¼‰
    var searchResults []*SearchResult
    for _, point := range results {
        result := &SearchResult{
            Score:       point.Score,
            SessionID:   point.Payload["session_id"].(string),
            TurnIndex:   int(point.Payload["turn_index"].(float64)),
            ResultType:  "turn",  // æ ‡è®°ä¸ºå¯¹è¯å¯¹ç±»å‹
            UserText:    point.Payload["user_text"].(string),
            AIText:      point.Payload["ai_text"].(string),
            CombinedText: point.Payload["combined_text"].(string),
            ProjectID:   point.Payload["project_id"].(string),
            ProjectName: point.Payload["project_name"].(string),
            Timestamp:   int64(point.Payload["timestamp"].(float64)),
        }
        searchResults = append(searchResults, result)
    }
    
    return searchResults, nil
}

// æœç´¢æ¶ˆæ¯çº§åˆ«
func (s *RAGService) searchMessages(queryVector []float32, filter *qdrant.Filter, limit int) ([]*SearchResult, error) {
    query := &qdrant.SearchPoints{
        CollectionName: "cursor_sessions_messages",
        Vector:         queryVector,
        Limit:          uint64(limit),
        WithPayload:    true,
        Filter:         filter,
    }
    
    results, err := s.qdrantClient.Search(query)
    if err != nil {
        return nil, err
    }
    
    // è½¬æ¢ä¸º SearchResultï¼ˆæ ‡è®°ä¸ºæ¶ˆæ¯ç±»å‹ï¼‰
    var searchResults []*SearchResult
    for _, point := range results {
        result := &SearchResult{
            Score:       point.Score,
            SessionID:   point.Payload["session_id"].(string),
            MessageID:   point.Payload["message_id"].(string),
            ResultType:  "message",  // æ ‡è®°ä¸ºæ¶ˆæ¯ç±»å‹
            Content:     point.Payload["content"].(string),
            MessageType: point.Payload["message_type"].(string),
            TurnIndex:   int(point.Payload["turn_index"].(float64)),
            ProjectID:   point.Payload["project_id"].(string),
            ProjectName: point.Payload["project_name"].(string),
            Timestamp:   int64(point.Payload["timestamp"].(float64)),
        }
        searchResults = append(searchResults, result)
    }
    
    return searchResults, nil
}

// åˆå¹¶ç»“æœå¹¶å»é‡
func (s *RAGService) mergeResults(turnResults, messageResults []*SearchResult) []*SearchResult {
    seen := make(map[string]bool)
    var merged []*SearchResult
    
    // å…ˆæ·»åŠ å¯¹è¯å¯¹ç»“æœï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
    for _, result := range turnResults {
        key := fmt.Sprintf("%s:turn-%d", result.SessionID, result.TurnIndex)
        if !seen[key] {
            merged = append(merged, result)
            seen[key] = true
        }
    }
    
    // å†æ·»åŠ æ¶ˆæ¯ç»“æœï¼ˆå¦‚æœå¯¹åº”çš„å¯¹è¯å¯¹æœªåŒ…å«ï¼‰
    for _, result := range messageResults {
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯¹åº”çš„å¯¹è¯å¯¹
        turnKey := fmt.Sprintf("%s:turn-%d", result.SessionID, result.TurnIndex)
        if !seen[turnKey] {
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²åŒ…å«
            msgKey := fmt.Sprintf("%s:%s", result.SessionID, result.MessageID)
            if !seen[msgKey] {
                merged = append(merged, result)
                seen[msgKey] = true
            }
        }
    }
    
    return merged
}

// æŒ‰ç›¸å…³æ€§æ’åºï¼ˆå¯¹è¯å¯¹ä¼˜å…ˆï¼‰
func (s *RAGService) sortByRelevance(results []*SearchResult, query string) []*SearchResult {
    sort.Slice(results, func(i, j int) bool {
        // å¯¹è¯å¯¹ä¼˜å…ˆï¼ˆåŒ…å«æ›´å¤šä¸Šä¸‹æ–‡ï¼‰
        if results[i].ResultType == "turn" && results[j].ResultType == "message" {
            // å¦‚æœå¯¹è¯å¯¹åˆ†æ•°è¶³å¤Ÿé«˜ï¼Œä¼˜å…ˆæ˜¾ç¤º
            if results[i].Score > 0.7 {
                return true
            }
        }
        if results[i].ResultType == "message" && results[j].ResultType == "turn" {
            if results[j].Score > 0.7 {
                return false
            }
        }
        
        // å¦åˆ™æŒ‰åˆ†æ•°æ’åº
        return results[i].Score > results[j].Score
    })
    
    return results
}
```

#### æœç´¢ UI è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœç´¢ä¼šè¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æœç´¢æ¡†: è¾“å…¥æŸ¥è¯¢...]                   â”‚
â”‚                                          â”‚
â”‚  é¡¹ç›®è¿‡æ»¤:                               â”‚
â”‚  â˜‘ æ‰€æœ‰é¡¹ç›®                              â”‚
â”‚  â˜ æŒ‡å®šé¡¹ç›®: [é€‰æ‹©é¡¹ç›®...] â–¼            â”‚
â”‚                                          â”‚
â”‚  å…¶ä»–è¿‡æ»¤:                               â”‚
â”‚  â€¢ æ¶ˆæ¯ç±»å‹: [å…¨éƒ¨] â–¼                    â”‚
â”‚  â€¢ æ—¶é—´èŒƒå›´: [å…¨éƒ¨æ—¶é—´] â–¼                â”‚
â”‚                                          â”‚
â”‚  [æœç´¢]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœç´¢ç»“æœå±•ç¤º:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š æ‰¾åˆ° 5 ä¸ªç›¸å…³ç»“æœ                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¼šè¯: RAG åŠŸèƒ½è®¾è®¡è®¨è®º               â”‚ â”‚
â”‚  â”‚ é¡¹ç›®: cocursor | ç›¸ä¼¼åº¦: 0.89       â”‚ â”‚
â”‚  â”‚ æ—¶é—´: 2å°æ—¶å‰                       â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ğŸ‘¤ ç”¨æˆ·: å¦‚ä½•è®¾è®¡ RAG åŠŸèƒ½ï¼Ÿ         â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚ ğŸ¤– AI: éœ€è¦å‘é‡åº“å’ŒåµŒå…¥æ¨¡å‹ã€‚       â”‚ â”‚
â”‚  â”‚     è®©æˆ‘å…ˆæŸ¥çœ‹ä¸€ä¸‹ç›¸å…³ä»£ç ...       â”‚ â”‚
â”‚  â”‚     æ ¹æ®ä»£ç åˆ†æï¼Œå»ºè®®ä½¿ç”¨ Qdrant   â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚ [å±•å¼€æŸ¥çœ‹è¯¦ç»†æ¶ˆæ¯] [æŸ¥çœ‹å®Œæ•´ä¼šè¯]   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¼šè¯: è·¨å¹³å°å…¼å®¹æ€§è®¨è®º               â”‚ â”‚
â”‚  â”‚ é¡¹ç›®: cocursor | ç›¸ä¼¼åº¦: 0.82       â”‚ â”‚
â”‚  â”‚ æ—¶é—´: 3å°æ—¶å‰                       â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ğŸ‘¤ ç”¨æˆ·: å¦‚ä½•ä¿è¯è·¨å¹³å°å…¼å®¹ï¼Ÿ       â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚ ğŸ¤– AI: éœ€è¦è‡ªåŠ¨ä¸‹è½½å¯¹åº”å¹³å°çš„       â”‚ â”‚
â”‚  â”‚     äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¯æŒ Windows/      â”‚ â”‚
â”‚  â”‚     macOS/Linux...                 â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚ [å±•å¼€æŸ¥çœ‹è¯¦ç»†æ¶ˆæ¯] [æŸ¥çœ‹å®Œæ•´ä¼šè¯]   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å±•å¼€åçš„è¯¦ç»†æ¶ˆæ¯:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ ç”¨æˆ·æ¶ˆæ¯                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  å¦‚ä½•è®¾è®¡ RAG åŠŸèƒ½ï¼Ÿ                     â”‚
â”‚  æ—¶é—´: 2024-01-15 10:30:00              â”‚
â”‚                                          â”‚
â”‚  ğŸ¤– AI å›å¤ #1                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  éœ€è¦å‘é‡åº“å’ŒåµŒå…¥æ¨¡å‹ã€‚è®©æˆ‘å…ˆæŸ¥çœ‹ä¸€ä¸‹    â”‚
â”‚  ç›¸å…³ä»£ç ã€‚                              â”‚
â”‚  æ—¶é—´: 2024-01-15 10:30:05              â”‚
â”‚  ğŸ”§ å·¥å…·è°ƒç”¨: read_file                  â”‚
â”‚                                          â”‚
â”‚  ğŸ¤– AI å›å¤ #2                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  æ ¹æ®ä»£ç åˆ†æï¼Œå»ºè®®ä½¿ç”¨ Qdrant åµŒå…¥å¼    â”‚
â”‚  æ¨¡å¼ã€‚                                  â”‚
â”‚  æ—¶é—´: 2024-01-15 10:30:15              â”‚
â”‚                                          â”‚
â”‚  [æ”¶èµ·] [æŸ¥çœ‹å®Œæ•´ä¼šè¯]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å››ã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 4.1 çŠ¶æ€æŒ‡ç¤º

#### çŠ¶æ€æ æ˜¾ç¤º

```
[CoCursor] RAG: å·²ç´¢å¼• 1,234 æ¡æ¶ˆæ¯ | æœ€åæ‰«æ: 2å°æ—¶å‰
```

#### ä¸»ç•Œé¢çŠ¶æ€å¡ç‰‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAG è¯­ä¹‰æœç´¢                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… å·²é…ç½®                               â”‚
â”‚  ğŸ“Š å·²ç´¢å¼•: 1,234 æ¡æ¶ˆæ¯                 â”‚
â”‚  ğŸ• æœ€åæ‰«æ: 2å°æ—¶å‰                    â”‚
â”‚  âš™ï¸  æ‰«æçŠ¶æ€: è¿è¡Œä¸­ (60%)             â”‚
â”‚                                          â”‚
â”‚  [ç«‹å³æ‰«æ] [æŸ¥çœ‹è®¾ç½®] [æœç´¢]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 é”™è¯¯å¤„ç†

#### å¸¸è§é”™è¯¯åœºæ™¯

1. **API è¿æ¥å¤±è´¥**
   - æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
   - æä¾›é‡è¯•æŒ‰é’®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

2. **API Key æ— æ•ˆ**
   - æç¤ºæ£€æŸ¥ API Key
   - æä¾›é‡æ–°é…ç½®å…¥å£

3. **Qdrant å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶
   - æä¾›é‡æ–°ä¸‹è½½é€‰é¡¹
   - æŸ¥çœ‹æ—¥å¿—

4. **æ‰«æä¸­æ–­**
   - ä¿å­˜è¿›åº¦
   - æ”¯æŒæ–­ç‚¹ç»­ä¼ 
   - æ˜¾ç¤ºå¤±è´¥åŸå› 

### 4.3 æ€§èƒ½ä¼˜åŒ–

#### æ‰¹é‡å¤„ç†

- **å‘é‡åŒ–**: æ‰¹é‡è°ƒç”¨ Embedding APIï¼ˆå‡å°‘è¯·æ±‚æ•°ï¼‰
- **å†™å…¥**: æ‰¹é‡å†™å…¥ Qdrantï¼ˆæé«˜ååé‡ï¼‰
- **å¹¶å‘æ§åˆ¶**: é™åˆ¶å¹¶å‘æ•°ï¼Œé¿å…è¿‡è½½

#### ç¼“å­˜ç­–ç•¥

- **é…ç½®ç¼“å­˜**: å†…å­˜ç¼“å­˜é…ç½®ï¼Œå‡å°‘è¯»å–
- **ä¼šè¯å…ƒæ•°æ®ç¼“å­˜**: ç¼“å­˜å·²ç´¢å¼•çš„ä¼šè¯åˆ—è¡¨
- **æœç´¢ç»“æœç¼“å­˜**: ç¼“å­˜çƒ­é—¨æŸ¥è¯¢ç»“æœ

### 4.4 ç”¨æˆ·å¼•å¯¼

#### é¦–æ¬¡ä½¿ç”¨å‘å¯¼

```
æ­¥éª¤ 1: ä»‹ç» RAG åŠŸèƒ½
    â†“
æ­¥éª¤ 2: é…ç½® Embedding API
    â†“
æ­¥éª¤ 3: ä¸‹è½½ Qdrant ç»„ä»¶
    â†“
æ­¥éª¤ 4: å¼€å§‹é¦–æ¬¡æ‰«æ
    â†“
æ­¥éª¤ 5: ä½“éªŒæœç´¢åŠŸèƒ½
```

## äº”ã€å·²ç¡®è®¤çš„å†³ç­–

### 5.1 æŠ€æœ¯é€‰å‹ç¡®è®¤

1. **Embedding API å¤„ç†æ–¹å¼**
   - âœ… æ”¯æŒæ‰€æœ‰å…¼å®¹ OpenAI Embeddings API æ ¼å¼çš„ API
   - âœ… ä¸é™åˆ¶ç‰¹å®šæä¾›å•†ï¼ˆOpenAIã€Azure OpenAIã€è‡ªå®šä¹‰ API ç­‰ï¼‰
   - âœ… é€šè¿‡æ ‡å‡†çš„ HTTP POST è¯·æ±‚è°ƒç”¨
   - âœ… è¯·æ±‚æ ¼å¼ï¼š`POST /v1/embeddings`ï¼ŒBody: `{"model": "...", "input": "..."}`
   - âœ… å“åº”æ ¼å¼ï¼š`{"data": [{"embedding": [...]}]}`

2. **æ‰«æç­–ç•¥**
   - âœ… å®šæ—¶æ‰«æ `~/.cursor/projects/` ç›®å½•
   - âœ… æ£€æµ‹ä¼šè¯æ–‡ä»¶ï¼ˆagent-transcripts/*.txtï¼‰çš„å˜åŒ–
   - âœ… é€šè¿‡æ–‡ä»¶ä¿®æ”¹æ—¶é—´åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°ç´¢å¼•
   - âœ… é»˜è®¤æ‰«æé¢‘ç‡ï¼šæ¯ 2 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
   - âœ… ä¸éœ€è¦åœ¨å‡Œæ™¨æ‰§è¡Œï¼Œä»»ä½•æ—¶é—´éƒ½å¯ä»¥

3. **Qdrant ç‰ˆæœ¬ç®¡ç†**
   - âœ… ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬ï¼šv1.16.3ï¼ˆ2024å¹´12æœˆï¼‰
   - âœ… é¦–æ¬¡ä¸‹è½½æ—¶é€šè¿‡ GitHub API è·å–æœ€æ–°ç¨³å®šç‰ˆ
   - âœ… ä¸‹è½½åå›ºå®šä½¿ç”¨è¯¥ç‰ˆæœ¬ï¼Œä¸æä¾›æ›´æ–°åŠŸèƒ½
   - âœ… ç‰ˆæœ¬å·è®°å½•åœ¨é…ç½®æ–‡ä»¶ä¸­

### 5.2 å¾…ç¡®è®¤çš„ç»†èŠ‚

1. **å­˜å‚¨ä½ç½®**
   - Qdrant æ•°æ®å­˜å‚¨è·¯å¾„ï¼šå»ºè®® `~/.cocursor/qdrant/`
   - æ˜¯å¦éœ€è¦æ”¯æŒè‡ªå®šä¹‰è·¯å¾„ï¼Ÿ

2. **èµ„æºå ç”¨**
   - æ‰«ææ—¶æ˜¯å¦é™åˆ¶ CPU/å†…å­˜ä½¿ç”¨ï¼Ÿ
   - æ˜¯å¦åœ¨åå°é™é»˜è¿è¡Œï¼Ÿ

3. **éšç§å’Œå®‰å…¨**
   - API Key åŠ å¯†å­˜å‚¨æ–¹å¼ï¼ˆä½¿ç”¨ç³»ç»Ÿå¯†é’¥åº“ï¼Ÿï¼‰
   - æ˜¯å¦éœ€è¦æ”¯æŒæœ¬åœ° Embedding æ¨¡å‹ä½œä¸ºå¤‡é€‰ï¼Ÿ

### 5.3 å®ç°è¦ç‚¹æ€»ç»“

#### Embedding API é€šç”¨å¤„ç†

```go
// æ”¯æŒæ‰€æœ‰å…¼å®¹ OpenAI æ ¼å¼çš„ API
type EmbeddingRequest struct {
    Model string   `json:"model"`
    Input []string `json:"input"`  // æ”¯æŒæ‰¹é‡
}

type EmbeddingResponse struct {
    Data []struct {
        Embedding []float32 `json:"embedding"`
        Index     int       `json:"index"`
    } `json:"data"`
}

// è°ƒç”¨æ–¹å¼
func (c *EmbeddingClient) EmbedTexts(texts []string) ([][]float32, error) {
    req := EmbeddingRequest{
        Model: c.config.Model,
        Input: texts,
    }
    // å‘é€ HTTP POST è¯·æ±‚
    // ä¸å…³å¿ƒå…·ä½“çš„ API æä¾›å•†ï¼Œåªè¦æ ¼å¼å…¼å®¹å³å¯
}
```

#### ç›®å½•æ‰«æå®ç°

```go
// æ‰«æ ~/.cursor/projects/ ç›®å½•
func (s *ScanScheduler) scanProjectsDir() error {
    projectsDir := filepath.Join(homeDir, ".cursor", "projects")
    
    // éå†æ‰€æœ‰é¡¹ç›®ç›®å½•
    entries, _ := os.ReadDir(projectsDir)
    for _, entry := range entries {
        if !entry.IsDir() {
            continue
        }
        
        projectKey := entry.Name()  // é¡¹ç›®ç›®å½•åå°±æ˜¯ project_key
        projectDir := filepath.Join(projectsDir, projectKey)
        transcriptsDir := filepath.Join(projectDir, "agent-transcripts")
        
        // è·å–é¡¹ç›®ä¿¡æ¯ï¼ˆä» ProjectManagerï¼‰
        projectInfo := s.projectManager.GetProjectByKey(projectKey)
        if projectInfo == nil {
            continue
        }
        
        // æ‰«æä¼šè¯æ–‡ä»¶
        transcriptFiles, _ := os.ReadDir(transcriptsDir)
        for _, file := range transcriptFiles {
            if !strings.HasSuffix(file.Name(), ".txt") {
                continue
            }
            
            sessionID := strings.TrimSuffix(file.Name(), ".txt")
            filePath := filepath.Join(transcriptsDir, file.Name())
            fileInfo, _ := os.Stat(filePath)
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç´¢å¼•ï¼ˆå¯¹æ¯”ä¿®æ”¹æ—¶é—´ï¼‰
            if s.needsIndex(sessionID, filePath, fileInfo.ModTime()) {
                // ç´¢å¼•ä¼šè¯ï¼ˆåŒ…å«é¡¹ç›®ä¿¡æ¯ï¼‰
                s.indexSessionFile(sessionID, filePath, projectInfo)
            }
        }
    }
}

// ç´¢å¼•ä¼šè¯æ–‡ä»¶ï¼ˆæ··åˆç­–ç•¥ï¼šæ¶ˆæ¯çº§åˆ« + å¯¹è¯å¯¹çº§åˆ«ï¼‰
func (s *ScanScheduler) indexSessionFile(sessionID, filePath string, projectInfo *ProjectInfo) error {
    // 1. è¯»å–ä¼šè¯æ¶ˆæ¯ï¼ˆä» transcript æ–‡ä»¶ï¼‰
    messages, err := s.sessionService.GetSessionTextContent(sessionID)
    if err != nil {
        return fmt.Errorf("failed to get session content: %w", err)
    }
    
    if len(messages) == 0 {
        log.Printf("[indexSessionFile] ä¼šè¯ %s æ²¡æœ‰å¯ç´¢å¼•çš„æ¶ˆæ¯", sessionID)
        return nil
    }
    
    // 2. ä¸ºæ¯æ¡æ¶ˆæ¯ç”Ÿæˆå”¯ä¸€ message_id
    // æ³¨æ„: transcript æ–‡ä»¶ä¸­çš„æ¶ˆæ¯æ²¡æœ‰æ˜ç¡®çš„ message_id
    // æˆ‘ä»¬ä½¿ç”¨æ¶ˆæ¯åœ¨ä¼šè¯ä¸­çš„ä½ç½®ç´¢å¼• + æ—¶é—´æˆ³ç”Ÿæˆå”¯ä¸€ ID
    indexedMessages := make([]*IndexedMessage, 0, len(messages))
    for i, msg := range messages {
        // ç”Ÿæˆ message_id: {session_id}-{index}-{timestamp}
        // ä¾‹å¦‚: "composer-xxx-0-1234567890"
        messageID := fmt.Sprintf("%s-%d-%d", sessionID, i, msg.Timestamp)
        
        indexedMessages = append(indexedMessages, &IndexedMessage{
            Message:  msg,
            MessageID: messageID,
            Index:    i,
        })
    }
    
    // 3. æå–æ–‡æœ¬å†…å®¹ï¼ˆè¿‡æ»¤ç©ºæ¶ˆæ¯ï¼‰
    texts := make([]string, 0, len(indexedMessages))
    validMessages := make([]*IndexedMessage, 0, len(indexedMessages))
    for _, im := range indexedMessages {
        text := strings.TrimSpace(im.Message.Text)
        if text == "" || len(text) < s.config.MinMessageLen {
            continue
        }
        texts = append(texts, text)
        validMessages = append(validMessages, im)
    }
    
    if len(texts) == 0 {
        log.Printf("[indexSessionFile] ä¼šè¯ %s æ²¡æœ‰æœ‰æ•ˆçš„æ–‡æœ¬æ¶ˆæ¯", sessionID)
        return nil
    }
    
    // 4. æ‰¹é‡å‘é‡åŒ–ï¼ˆè°ƒç”¨ Embedding APIï¼‰
    log.Printf("[indexSessionFile] å¼€å§‹å‘é‡åŒ– %d æ¡æ¶ˆæ¯", len(texts))
    vectors, err := s.embeddingService.EmbedTexts(texts)
    if err != nil {
        return fmt.Errorf("failed to embed texts: %w", err)
    }
    
    if len(vectors) != len(texts) {
        return fmt.Errorf("vector count mismatch: expected %d, got %d", len(texts), len(vectors))
    }
    
    // 5. å‡†å¤‡ Qdrant ç‚¹ï¼ˆä½¿ç”¨å›ºå®š ID æ ¼å¼ï¼Œæ”¯æŒè¦†ç›–ï¼‰
    points := make([]*qdrant.PointStruct, len(validMessages))
    for i, im := range validMessages {
        // vector_id æ ¼å¼: {session_id}:{message_id}
        // ä¾‹å¦‚: "composer-xxx:composer-xxx-0-1234567890"
        vectorID := fmt.Sprintf("%s:%s", sessionID, im.MessageID)
        
        points[i] = &qdrant.PointStruct{
            Id: &qdrant.PointId{
                PointIdOptions: &qdrant.PointId_Uuid{
                    Uuid: vectorID,  // ä½¿ç”¨å›ºå®šæ ¼å¼ï¼Œæ›´æ–°æ—¶ç›´æ¥è¦†ç›–
                },
            },
            Vectors: &qdrant.Vectors{
                VectorsOptions: &qdrant.Vectors_Vector{
                    Vector: &qdrant.Vector{
                        Data: vectors[i],  // å¯¹åº”çš„å‘é‡
                    },
                },
            },
            Payload: map[string]interface{}{
                "session_id":   sessionID,
                "message_id":   im.MessageID,
                "message_type": string(im.Message.Type),  // "user" æˆ– "ai"
                "content":      im.Message.Text,          // åŸå§‹æ–‡æœ¬å†…å®¹
                "timestamp":    im.Message.Timestamp,     // æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
                "message_index": im.Index,                // æ¶ˆæ¯åœ¨ä¼šè¯ä¸­çš„ä½ç½®
                "project_id":    projectInfo.ProjectID,   // é¡¹ç›®å”¯ä¸€ ID
                "project_name":  projectInfo.ProjectName, // é¡¹ç›®æ˜¾ç¤ºåç§°
                "workspace_id":  s.getWorkspaceID(sessionID, projectInfo), // å·¥ä½œåŒº ID
            },
        }
    }
    
    // 6. Upsert åˆ° Qdrantï¼ˆç›´æ¥è¦†ç›–ï¼Œå¦‚æœå·²å­˜åœ¨ï¼‰
    log.Printf("[indexSessionFile] å†™å…¥ %d ä¸ªå‘é‡åˆ° Qdrant", len(points))
    err = s.qdrantClient.Upsert("cursor_sessions", points)
    if err != nil {
        return fmt.Errorf("failed to upsert to Qdrant: %w", err)
    }
    
    // 7. æ›´æ–°å…ƒæ•°æ®è¡¨ï¼ˆè®°å½•ç´¢å¼•ä¿¡æ¯ï¼‰
    fileInfo, _ := os.Stat(filePath)
    fileMtime := int64(0)
    if fileInfo != nil {
        fileMtime = fileInfo.ModTime().Unix()
    }
    
    contentHash := s.calculateFileHash(filePath)
    
    for _, im := range validMessages {
        err = s.updateMetadata(&IndexMetadata{
            SessionID:   sessionID,
            MessageID:   im.MessageID,
            WorkspaceID: s.getWorkspaceID(sessionID, projectInfo),
            ProjectID:   projectInfo.ProjectID,
            ProjectName: projectInfo.ProjectName,
            VectorID:    fmt.Sprintf("%s:%s", sessionID, im.MessageID),
            ContentHash: contentHash,
            FilePath:    filePath,
            FileMtime:   fileMtime,
            IndexedAt:   time.Now().Unix(),
        })
        if err != nil {
            log.Printf("[indexSessionFile] æ›´æ–°å…ƒæ•°æ®å¤±è´¥: %v", err)
            // ä¸é˜»æ­¢æµç¨‹ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€æ¡
        }
    }
    
    log.Printf("[indexSessionFile] ä¼šè¯ %s ç´¢å¼•å®Œæˆ: %d æ¡æ¶ˆæ¯", sessionID, len(validMessages))
    return nil
}

// IndexedMessage å¸¦ç´¢å¼•ä¿¡æ¯çš„æ¶ˆæ¯
type IndexedMessage struct {
    Message   *domainCursor.Message
    MessageID string  // ç”Ÿæˆçš„å”¯ä¸€æ¶ˆæ¯ ID
    Index     int     // æ¶ˆæ¯åœ¨ä¼šè¯ä¸­çš„ä½ç½®ç´¢å¼•
}

// IndexMetadata ç´¢å¼•å…ƒæ•°æ®
type IndexMetadata struct {
    SessionID   string
    MessageID   string
    WorkspaceID string
    ProjectID   string
    ProjectName string
    VectorID    string
    ContentHash string
    FilePath    string
    FileMtime   int64
    IndexedAt   int64
}
```

#### Qdrant ç‰ˆæœ¬å›ºå®š

```go
const QdrantVersion = "v1.16.3"  // å›ºå®šç‰ˆæœ¬

func getQdrantDownloadURL(platform, arch string) string {
    baseURL := "https://github.com/qdrant/qdrant/releases/download"
    filename := fmt.Sprintf("qdrant-%s-%s-%s.zip", 
        QdrantVersion, arch, getPlatformSuffix(platform))
    return fmt.Sprintf("%s/%s/%s", baseURL, QdrantVersion, filename)
}
```

### 5.4 å»ºè®®çš„ä¼˜åŒ–ï¼ˆåç»­ï¼‰

1. **æ¸è¿›å¼ç´¢å¼•**
   - ä¼˜å…ˆç´¢å¼•æœ€è¿‘çš„ä¼šè¯
   - æŒ‰æ—¶é—´å€’åºç´¢å¼•

2. **æ™ºèƒ½å»é‡**
   - æ£€æµ‹é‡å¤æ¶ˆæ¯
   - åªç´¢å¼•å”¯ä¸€å†…å®¹

3. **ç´¢å¼•å‹ç¼©**
   - å®šæœŸæ¸…ç†æ— æ•ˆå‘é‡
   - åˆå¹¶ç›¸ä¼¼å‘é‡

4. **æœç´¢ä¼˜åŒ–**
   - æ”¯æŒæ··åˆæœç´¢ï¼ˆå‘é‡ + å…³é”®è¯ï¼‰
   - æ”¯æŒè¿‡æ»¤ï¼ˆæŒ‰æ—¶é—´ã€å·¥ä½œåŒºã€é¡¹ç›®ï¼‰
